---
title: "Free the modeler in you: Intro to Nimble"
author: "The team"
date: "last updated: `r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: [default, "slides-theme.css"]
    lib_dir: libs
    nature:
      ratio: '16:9'
      highlightStyle: github
      highlightLines: true
      slideNumberFormat: ''
      titleSlideClass: [center, middle]
---

```{r setup, include=FALSE, echo=FALSE, massage = FALSE, warning=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(comment = "")

library(tidyverse)
theme_set(theme_light())
update_geom_defaults("point", list(size = 2)) 
library(here)
library(nimble)
```

# What is NIMBLE?

--

+ A framework for hierarchical statistical models and methods.

--

+ A nearly drop-in alternative to WinBUGS, OpenBUGS and JAGS.

--

+ An extension of the BUGS language for writing new functions and distributions.

--

+ A configurable system for MCMC.

--

+ A library of other methods (SMC, MCEM).

???

+ Sequential Monte Carlo (particle filtering)
+ Monte Carlo Expectation Maximization (maximum likelihood)


--

+ A model-generic programming system to write new analysis methods.

--

+ Numerical Inference for statistical Models using Bayesian and Likelihood Estimation.


---
## Load `nimble` package

```{r}
library(nimble)
```

---
## Build model, made of likelihood and priors

```{r}
naive.survival.model <- nimbleCode({
  # prior
  phi ~ dunif(0, 1)
  # likelihood
  y ~ dbinom(phi, n)
})
```

---
## Read in data

```{r}
my.data <- list(n = 57, y = 19)
```

---
## Specify initial values

```{r}
initial.values <- function() list(phi = runif(1,0,1))
```

--

```{r}
initial.values()
```


---
## Which parameters to save?

```{r}
parameters.to.save <- c("phi")
```

---
## MCMC details

```{r}
n.iter <- 5000
n.burnin <- 1000
n.chains <- 2
```


---
## Run model, tadaa!

```{r, warning=FALSE, message=FALSE, eval = FALSE}
mcmc.output <- nimbleMCMC(code = naive.survival.model,     
                          data = my.data,              
                          inits = initial.values,
                          monitors = parameters.to.save,
                          niter = n.iter, 
                          nburnin = n.burnin, 
                          nchains = n.chains,
                          )
```

```{r, cache = TRUE, echo = FALSE, warning=FALSE, message=FALSE}
mcmc.output <- nimbleMCMC(code = naive.survival.model,     
                          data = my.data,              
                          inits = initial.values,
                          monitors = parameters.to.save,
                          niter = n.iter, 
                          nburnin = n.burnin, 
                          nchains = n.chains,
                          progressBar = FALSE)
```




---
## Explore MCMC outputs

```{r}
str(mcmc.output)
```


---
## Explore MCMC outputs

```{r}
head(mcmc.output$chain1)
```

---
## Explore MCMC outputs

.center.nogap[
```{r, echo = FALSE, fig.width = 7.5, fig.asp = 0.618, dev = "svg", message=FALSE, warning=FALSE}
mcmc.output %>%
  as_tibble() %>%
  janitor::clean_names() %>%
  ggplot() + 
  geom_histogram(aes(x = chain1[,"phi"]), color = "white") + 
  labs(x = "survival probability")
```
]

---
## Numerical summaries

```{r}
library(MCMCvis)
MCMCsummary(mcmc.output, round = 2)
```

---
## Trace and posterior density

.pull-left[

```{r eval = FALSE}
MCMCtrace(mcmc.output,
          pdf = FALSE) 
```
]

--

.pull-right[

.center.nogap[
```{r, echo = FALSE, fig.width = 7.5, fig.asp = 0.618, dev = "svg", message=FALSE, warning=FALSE}
MCMCtrace(mcmc.output,
          pdf = FALSE) 
```
]
]




---
## Trace and posterior density

.pull-left[

```{r eval = FALSE}
MCMCtrace(mcmc.output,
          pdf = FALSE,
          ind = TRUE,
          Rhat = TRUE,
          n.eff = TRUE) 
```
]

--

.pull-right[

.center.nogap[
```{r, echo = FALSE, fig.width = 7.5, fig.asp = 0.618, dev = "svg", message=FALSE, warning=FALSE}
MCMCtrace(mcmc.output,
          pdf = FALSE,
          ind = TRUE,
          Rhat = TRUE,
          n.eff = TRUE) 
```
]
]

---
## More

+ Explain workflow.
+ Distinguish data and constants, redo survival example w/ $n$ constant and $y$ data.
+ Distribution dnorm, dunif, etc.
+ Vectorise to speed up.
+ Say that we'll see more advanced use as the workshop goes, on the fly.

---

![](img/nimble_workflow.png)


---
## Useful resources

+ Official website [https://r-nimble.org](https://r-nimble.org)

+ User Manual [https://r-nimble.org/html_manual/cha-welcome-nimble.html](https://r-nimble.org/html_manual/cha-welcome-nimble.html)

+ Users mailing list [https://groups.google.com/forum/#!forum/nimble-users](https://groups.google.com/forum/#!forum/nimble-users)

+ Training material [https://github.com/nimble-training](https://github.com/nimble-training)

+ Reference to cite when using nimble in a publication:

de Valpine, Perry, Daniel Turek, Christopher J. Paciorek, Clifford Anderson-Bergman, Duncan Temple Lang, and Rastislav Bodik (2017). Programming With Models: Writing Statistical Algorithms for General Model Structures With NIMBLE. *Journal of Computational and Graphical Statistics* **26** (2): 403–13. <https://doi.org/10.1080/10618600.2016.1172487>.


---
# To-do list

+ I chose to start w/ nimbleMCMC() so that Jags users can catch up in a second, and beginners are not overwhelmed with the different steps that are relevant to more advanced users

+ Free the modeler is from Marc Kéry

+ Do we need to say anything about why Nimble and not Jags or Stan?

+ NIMBLE, Nimble or nimble - homogeneise.
