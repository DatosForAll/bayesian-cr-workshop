---
title: "Free the modeler in you: Intro to Nimble"
author: "The team"
date: "last updated: `r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: [default, "slides-theme.css"]
    lib_dir: libs
    nature:
      ratio: '16:9'
      highlightStyle: github
      highlightLines: true
      slideNumberFormat: ''
      titleSlideClass: [center, middle]
---

```{r setup, include=FALSE, echo=FALSE, massage = FALSE, warning=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(comment = "")

library(tidyverse)
theme_set(theme_light())
update_geom_defaults("point", list(size = 2)) 
library(here)
library(nimble)
```

# What is Nimble?

--

+ **N**umerical **I**nference for statistical **M**odels using **B**ayesian and **L**ikelihood **E**stimation.

--

+ A framework for hierarchical statistical models and methods.

--

+ A nearly drop-in alternative to WinBUGS, OpenBUGS and JAGS.

--

+ An extension of the BUGS language for writing new functions and distributions.

--

+ A configurable system for MCMC.

--

+ A library of other methods (SMC, MCEM).

???

+ Sequential Monte Carlo (particle filtering)
+ Monte Carlo Expectation Maximization (maximum likelihood)


--

+ A model-generic programming system to write new analysis methods.


---
## Load `nimble` package

```{r}
library(nimble)
```

---
## Build model, made of likelihood and priors

```{r}
naive.survival.model <- nimbleCode({
  # prior
  phi ~ dunif(0, 1)
  # likelihood
  y ~ dbinom(phi, n)
})
```

---
## Read in data

```{r}
my.data <- list(n = 57, y = 19)
```


---
## Distinguish constants and data

```{r}
my.constants <- list(n = 57)
my.data <- list(y = 19)
```


---
## Specify initial values

```{r}
initial.values <- function() list(phi = runif(1,0,1))
```

--

```{r}
initial.values()
```


---
## Which parameters to save?

```{r}
parameters.to.save <- c("phi")
```

---
## MCMC details

```{r}
n.iter <- 5000
n.burnin <- 1000
n.chains <- 2
```


---
## Run model, tadaa!

```{r, warning=FALSE, message=FALSE, eval = FALSE}
mcmc.output <- nimbleMCMC(code = naive.survival.model,     
                          data = my.data,  
                          constants = my.constants,
                          inits = initial.values,
                          monitors = parameters.to.save,
                          niter = n.iter, 
                          nburnin = n.burnin, 
                          nchains = n.chains,
                          )
```

```{r, cache = TRUE, echo = FALSE, warning=FALSE, message=FALSE}
mcmc.output <- nimbleMCMC(code = naive.survival.model,     
                          data = my.data,              
                          constants = my.constants,
                          inits = initial.values,
                          monitors = parameters.to.save,
                          niter = n.iter, 
                          nburnin = n.burnin, 
                          nchains = n.chains,
                          progressBar = FALSE)
```




---
## Explore MCMC outputs

```{r}
str(mcmc.output)
```


---
## Explore MCMC outputs

```{r}
head(mcmc.output$chain1)
```

---
## Explore MCMC outputs

.center.nogap[
```{r, echo = FALSE, fig.width = 7.5, fig.asp = 0.618, dev = "svg", message=FALSE, warning=FALSE}
mcmc.output %>%
  as_tibble() %>%
  janitor::clean_names() %>%
  ggplot() + 
  geom_histogram(aes(x = chain1[,"phi"]), color = "white") + 
  labs(x = "survival probability")
```
]

---
## Numerical summaries

```{r}
library(MCMCvis)
MCMCsummary(mcmc.output, round = 2)
```

---
## Trace and posterior density

.pull-left[

```{r eval = FALSE}
MCMCtrace(mcmc.output,
          pdf = FALSE) 
```
]

--

.pull-right[

.center.nogap[
```{r, echo = FALSE, fig.width = 7.5, fig.asp = 0.618, dev = "svg", message=FALSE, warning=FALSE}
MCMCtrace(mcmc.output,
          pdf = FALSE) 
```
]
]




---
## Trace and posterior density

.pull-left[

```{r eval = FALSE}
MCMCtrace(mcmc.output,
          pdf = FALSE,
          ind = TRUE,
          Rhat = TRUE,
          n.eff = TRUE) 
```
]

--

.pull-right[

.center.nogap[
```{r, echo = FALSE, fig.width = 7.5, fig.asp = 0.618, dev = "svg", message=FALSE, warning=FALSE}
MCMCtrace(mcmc.output,
          pdf = FALSE,
          ind = TRUE,
          Rhat = TRUE,
          n.eff = TRUE) 
```
]
]

---
## Our `nimble` workflow so far

![](img/nimble_workflow_sofar.png)


---
## But `nimble` gives full access to the MCMC engine

--

![](img/nimble_workflow.png)

---
class: middle center
background-color: black

![](img/I1bIY06.gif)

---
## Useful resources

+ Official website [https://r-nimble.org](https://r-nimble.org)

+ User Manual [https://r-nimble.org/html_manual/cha-welcome-nimble.html](https://r-nimble.org/html_manual/cha-welcome-nimble.html)

+ Users mailing list [https://groups.google.com/forum/#!forum/nimble-users](https://groups.google.com/forum/#!forum/nimble-users)

+ Training material [https://github.com/nimble-training](https://github.com/nimble-training)

+ Reference to cite when using nimble in a publication:

> de Valpine, P., D. Turek, C. J. Paciorek, C. Anderson-Bergman, D. Temple Lang, and R. Bodik (2017). Programming With Models: Writing Statistical Algorithms for General Model Structures With NIMBLE. *Journal of Computational and Graphical Statistics* **26** (2): 403â€“13.


---
background-color: black
# <span style="color:white">Live demo</span>

<br>
<br>

.center[
![](img/r_1051694_ifmHZ.gif)
]

