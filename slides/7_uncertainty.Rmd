---
title: "Known knowns, unknown knowns and unknowns: Uncertainty in state assignment"
author: "The team"
date: "last updated: `r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: [default, "slides-theme.css"]
    lib_dir: libs
    nature:
      ratio: '16:9'
      highlightStyle: github
      highlightLines: true
      slideNumberFormat: ''
      titleSlideClass: [center, middle]
---

```{r setup, include=FALSE, echo=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(comment = "")

library(tidyverse)
theme_set(theme_light())
update_geom_defaults("point", list(size = 2)) 
library(here)
library(nimble)
```




---

## Uncertainty in state assignment

Multievent models extend multistate models with uncertainty in state assignment

--

+ Breeding status in female roe deer is ascertained based on fawn detection

--

+ Sex status is ascertained based on morphological criteria in Audouin's gulls

--

+ Disease status in house finches is ascertained based on birds' eyes examination

--

+ Hybrid status in wolves is ascertained based on genetics

--

+ Dominance status in wolves is ascertained based on heterogeneity in detection

---

+ We will need to explicitely consider state assignment in a model

--

+ All capture-recapture models can be seen as special cases of multievent models

---
## Examples

+ Breeding
+ Disease
+ Heterogeneity

---
# Uncertainty in breeding status

+ 3 states
    + breeding (B)
    + non-breeding (NB)
    + Dead (â€ )
+ 4 observations
    + Not encountered (0)
    + Found, ascertained as breeder (1)
    + Found, ascertained as non-breeder (2)
    + Found, status unknown (3)


---
class: middle
### The model construction: How we should think. 

.center.nogap[
```{r, echo = FALSE, fig.width = 7.5, fig.asp = 0.718, dev = "svg", message = FALSE, warning = FALSE}
ggplot() + 
  geom_point(aes(1, 1), size = 2.5, alpha = .7) + 
  geom_point(aes(1, 1.5), size = 2.5, alpha = .7) + 
  geom_point(aes(1, 2), size = 2.5, alpha = .7) + 
  geom_text(aes(1.5, 2, label = 'not encountered (0)'), nudge_x = 1, size = 7) + 
  geom_text(aes(1.5, 1.5, label = 'found, ascertained as breeder (1)'), nudge_x = 1.5, size = 7) + 
  geom_text(aes(1.5, 1, label = 'found, ascertained as non-breeder (2)'), nudge_x = 1.7, size = 7) +
  geom_text(aes(1.5, 0.5, label = 'found, status unknown (3)'), nudge_x = 1.2, size = 7) +
  geom_point(aes(1.5, 0.5), size = 2.5, alpha = .7) + 
  geom_point(aes(1.5, 1), size = 2.5, alpha = .7) + 
  geom_point(aes(1.5, 1.5), size = 2.5, alpha = .7) + 
  geom_point(aes(1.5, 2), size = 2.5, alpha = .7) + 
  geom_text(aes(.5, 2, label = 'breeding'), nudge_x = 0, size = 7) + 
  geom_text(aes(.5, 1.5, label = 'non-breeding'), nudge_x = -0.2, size = 7) + 
  geom_text(aes(.5, 1, label = 'dead'), nudge_x = 0.1, size = 7) + 
  xlim(0, 4.5) + 
  ylim(0.5, 3) + 
  annotate('text', x = .5, y = 2.6, label = 'States', size = 10) + 
  annotate('text', x = 2.5, y = 2.6, label = 'Observations', size = 10) + 
  theme_void()
```
]



---
class: middle
### The model construction: How we should think. 

.center.nogap[
```{r, echo = FALSE, fig.width = 7.5, fig.asp = 0.718, dev = "svg", message = FALSE, warning = FALSE}
ggplot() + 
  geom_point(aes(1, 1), size = 2.5, alpha = .7) + 
  geom_point(aes(1, 1.5), size = 2.5, alpha = .7) + 
  geom_point(aes(1, 2), size = 2.5, alpha = .7) + 
  geom_text(aes(1.5, 2, label = 'not encountered (0)'), nudge_x = 1, size = 7) + 
  geom_text(aes(1.5, 1.5, label = 'found, ascertained as breeder (1)'), nudge_x = 1.5, size = 7) + 
  geom_text(aes(1.5, 1, label = 'found, ascertained as non-breeder (2)'), nudge_x = 1.7, size = 7) +
  geom_text(aes(1.5, 0.5, label = 'found, status unknown (3)'), nudge_x = 1.2, size = 7) +
  geom_point(aes(1.5, 0.5), size = 2.5, alpha = .7) + 
  geom_point(aes(1.5, 1), size = 2.5, alpha = .7) + 
  geom_point(aes(1.5, 1.5), size = 2.5, alpha = .7) + 
  geom_point(aes(1.5, 2), size = 2.5, alpha = .7) + 
  geom_text(aes(.5, 2, label = 'breeding'), nudge_x = 0, size = 7) + 
  geom_text(aes(.5, 1.5, label = 'non-breeding'), nudge_x = -0.2, size = 7) + 
  geom_text(aes(.5, 1, label = 'dead'), nudge_x = 0.1, size = 7) + 
  xlim(0, 4.5) + 
  ylim(0.5, 3) + 
  annotate('text', x = .5, y = 2.6, label = 'States', size = 10) + 
  annotate('text', x = 2.5, y = 2.6, label = 'Observations', size = 10) + 
  geom_segment(aes(x = 1, y = 1, xend = 1.5, yend = 2), alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  theme_void()
```
]


---
class: middle
### The model construction: How we should think. 

.center.nogap[
```{r, echo = FALSE, fig.width = 7.5, fig.asp = 0.718, dev = "svg", message = FALSE, warning = FALSE}
ggplot() + 
  geom_point(aes(1, 1), size = 2.5, alpha = .7) + 
  geom_point(aes(1, 1.5), size = 2.5, alpha = .7) + 
  geom_point(aes(1, 2), size = 2.5, alpha = .7) + 
  geom_text(aes(1.5, 2, label = 'not encountered (0)'), nudge_x = 1, size = 7) + 
  geom_text(aes(1.5, 1.5, label = 'found, ascertained as breeder (1)'), nudge_x = 1.5, size = 7) + 
  geom_text(aes(1.5, 1, label = 'found, ascertained as non-breeder (2)'), nudge_x = 1.7, size = 7) +
  geom_text(aes(1.5, 0.5, label = 'found, status unknown (3)'), nudge_x = 1.2, size = 7) +
  geom_point(aes(1.5, 0.5), size = 2.5, alpha = .7) + 
  geom_point(aes(1.5, 1), size = 2.5, alpha = .7) + 
  geom_point(aes(1.5, 1.5), size = 2.5, alpha = .7) + 
  geom_point(aes(1.5, 2), size = 2.5, alpha = .7) + 
  geom_text(aes(.5, 2, label = 'breeding'), nudge_x = 0, size = 7) + 
  geom_text(aes(.5, 1.5, label = 'non-breeding'), nudge_x = -0.2, size = 7) + 
  geom_text(aes(.5, 1, label = 'dead'), nudge_x = 0.1, size = 7) + 
  xlim(0, 4.5) + 
  ylim(0.5, 3) + 
  annotate('text', x = .5, y = 2.6, label = 'States', size = 10) + 
  annotate('text', x = 2.5, y = 2.6, label = 'Observations', size = 10) + 
  geom_segment(aes(x = 1, y = 2, xend = 1.5, yend = .5), alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  geom_segment(aes(x = 1, y = 2, xend = 1.5, yend = 1.5), alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  geom_segment(aes(x = 1, y = 2, xend = 1.5, yend = 2), alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 

  theme_void()
```
]



---
class: middle
### The model construction: How we should think. 

.center.nogap[
```{r, echo = FALSE, fig.width = 7.5, fig.asp = 0.718, dev = "svg", message = FALSE, warning = FALSE}
ggplot() + 
  geom_point(aes(1, 1), size = 2.5, alpha = .7) + 
  geom_point(aes(1, 1.5), size = 2.5, alpha = .7) + 
  geom_point(aes(1, 2), size = 2.5, alpha = .7) + 
  geom_text(aes(1.5, 2, label = 'not encountered (0)'), nudge_x = 1, size = 7) + 
  geom_text(aes(1.5, 1.5, label = 'found, ascertained as breeder (1)'), nudge_x = 1.5, size = 7) + 
  geom_text(aes(1.5, 1, label = 'found, ascertained as non-breeder (2)'), nudge_x = 1.7, size = 7) +
  geom_text(aes(1.5, 0.5, label = 'found, status unknown (3)'), nudge_x = 1.2, size = 7) +
  geom_point(aes(1.5, 0.5), size = 2.5, alpha = .7) + 
  geom_point(aes(1.5, 1), size = 2.5, alpha = .7) + 
  geom_point(aes(1.5, 1.5), size = 2.5, alpha = .7) + 
  geom_point(aes(1.5, 2), size = 2.5, alpha = .7) + 
  geom_text(aes(.5, 2, label = 'breeding'), nudge_x = 0, size = 7) + 
  geom_text(aes(.5, 1.5, label = 'non-breeding'), nudge_x = -0.2, size = 7) + 
  geom_text(aes(.5, 1, label = 'dead'), nudge_x = 0.1, size = 7) + 
  xlim(0, 4.5) + 
  ylim(0.5, 3) + 
  annotate('text', x = .5, y = 2.6, label = 'States', size = 10) + 
  annotate('text', x = 2.5, y = 2.6, label = 'Observations', size = 10) + 
  geom_segment(aes(x = 1, y = 1.5, xend = 1.5, yend = 1), alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  geom_segment(aes(x = 1, y = 1.5, xend = 1.5, yend = 2), alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  geom_segment(aes(x = 1, y = 1.5, xend = 1.5, yend = .5), alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  theme_void()
```
]




---
class: middle
### The model construction: How we should think. 

.center.nogap[
```{r, echo = FALSE, fig.width = 7.5, fig.asp = 0.718, dev = "svg", message = FALSE, warning = FALSE}
ggplot() + 
  geom_point(aes(1, 1), size = 2.5, alpha = .7) + 
  geom_point(aes(1, 1.5), size = 2.5, alpha = .7) + 
  geom_point(aes(1, 2), size = 2.5, alpha = .7) + 
  geom_text(aes(1.5, 2, label = 'not encountered (0)'), nudge_x = 1, size = 7) + 
  geom_text(aes(1.5, 1.5, label = 'found, ascertained as breeder (1)'), nudge_x = 1.5, size = 7) + 
  geom_text(aes(1.5, 1, label = 'found, ascertained as non-breeder (2)'), nudge_x = 1.7, size = 7) +
  geom_text(aes(1.5, 0.5, label = 'found, status unknown (3)'), nudge_x = 1.2, size = 7) +
  geom_point(aes(1.5, 0.5), size = 2.5, alpha = .7) + 
  geom_point(aes(1.5, 1), size = 2.5, alpha = .7) + 
  geom_point(aes(1.5, 1.5), size = 2.5, alpha = .7) + 
  geom_point(aes(1.5, 2), size = 2.5, alpha = .7) + 
  geom_text(aes(.5, 2, label = 'breeding'), nudge_x = 0, size = 7) + 
  geom_text(aes(.5, 1.5, label = 'non-breeding'), nudge_x = -0.2, size = 7) + 
  geom_text(aes(.5, 1, label = 'dead'), nudge_x = 0.1, size = 7) + 
  xlim(0, 4.5) + 
  ylim(0.5, 3) + 
  annotate('text', x = .5, y = 2.6, label = 'States', size = 10) + 
  annotate('text', x = 2.5, y = 2.6, label = 'Observations', size = 10) + 
  
  geom_segment(aes(x = 1, y = 1, xend = 1.5, yend = 2), alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  
  geom_segment(aes(x = 1, y = 1.5, xend = 1.5, yend = 1), lty = 2, alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  geom_segment(aes(x = 1, y = 1.5, xend = 1.5, yend = 2), lty = 2, alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  geom_segment(aes(x = 1, y = 1.5, xend = 1.5, yend = .5), lty = 2, alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  
  geom_segment(aes(x = 1, y = 2, xend = 1.5, yend = .5), lty = 2, alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  geom_segment(aes(x = 1, y = 2, xend = 1.5, yend = 1.5), lty = 2, alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  geom_segment(aes(x = 1, y = 2, xend = 1.5, yend = 2), lty = 2, alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 

  theme_void()
```
]


---
### HMM model for breeding states w/ uncertainty

Vector of initial state probabilities

$$
\begin{matrix}
& \\
\mathbf{\delta} = 
    \left ( \vphantom{ \begin{matrix} 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    z_t=B & z_t=NB & z_t=D \\ \hdashline
\pi_B & 1 - \pi_{B} & 0\\ 
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \end{matrix} } \right )
    \begin{matrix}
    \end{matrix}
\end{matrix}
$$
+ $\pi_B$ is the probability that a newly encountered individual is a breeder

+ $\pi_{NB} = 1 - \pi_B$ is the probability that a newly encountered individual is a non-breeder

---
### HMM model for breeding states w/ uncertainty

Transition matrix:

$$
\begin{matrix}
& \\
\mathbf{\Gamma} = 
    \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    z_t=B & z_t=NB & z_t=D \\ \hdashline
\phi_B (1-\psi_{BNB}) & \phi_B \psi_{BNB} & 1 - \phi_B\\ 
\phi_{NB} \psi_{NBB} & \phi_{NB} (1-\psi_{NBB}) & 1 - \phi_{NB}\\ 
0 & 0 & 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right )
    \begin{matrix}
    z_{t-1}=B \\ z_{t-1}=NB \\ z_{t-1}=D
    \end{matrix}
\end{matrix}
$$

+ $\phi_B$

+ $\phi_{NB}$


---
### HMM model for breeding states w/ uncertainty

Observation matrix:

$$
\begin{matrix}
& \\
\mathbf{\Omega} = 
    \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12\end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    y_t=0 & y_t=1 & y_t=2 & y_t=3\\ \hdashline
p_B \beta_B & 0 & p_B (1-\beta_B) & 1-p_B\\ 
0 & p_{NB} \beta_{NB} & p_{NB} (1-\beta_{NB}) & 1-p_{NB}\\ 
0 & 0 & 0 & 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12\end{matrix} } \right )
    \begin{matrix}
    z_{t}=B \\ z_{t}=NB \\ z_{t}=D
    \end{matrix}
\end{matrix}
$$

+ $\beta_B$ is the probability to assign an individual in state B to state B

+ $\beta_{NB}$ is the probability to assign an individual in state NB to state NB



---
### HMM model for breeding states w/ uncertainty

Because animals are all captured, $p_B = p_{NB} = 1$ at first encounter:

$$
\begin{matrix}
& \\
\mathbf{\Omega.init} = 
    \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12\end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    y_t=0 & y_t=1 & y_t=2 & y_t=3\\ \hdashline
 \beta_B & 0 & (1-\beta_B) & 0\\ 
0 & \beta_{NB} & (1-\beta_{NB}) & 0\\ 
0 & 0 & 0 & 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12\end{matrix} } \right )
    \begin{matrix}
    z_{t}=B \\ z_{t}=NB \\ z_{t}=D
    \end{matrix}
\end{matrix}
$$

Note: Breeding assessment is unaffected.

---
### Our model $(\phi_A, \phi_B, \psi_{AB}, \psi_{BA}, p_A, p_B)$

.tiny-font[
```{r eval = FALSE}
multisite <- nimbleCode({
  # -------------------------------------------------
  # Parameters:
  # phiA: survival probability site A
  # phiB: survival probability site B
  # psiAB: movement probability from site A to site B
  # psiBA: movement probability from site B to site A
  # pA: recapture probability site A
  # pB: recapture probability site B
  # -------------------------------------------------
  # States (S):
  # 1 alive at A
  # 2 alive at B
  # 3 dead
  # Observations (O):  
  # 1 not seen
  # 2 seen at A 
  # 3 seen at B
  # -------------------------------------------------
...
```
]


---
### Our model $(\phi_A, \phi_B, \psi_{AB}, \psi_{BA}, p_A, p_B)$

.small-font[
```{r eval = FALSE}
multisite <- nimbleCode({
...
  # Priors
  phiA ~ dunif(0, 1)
  phiB ~ dunif(0, 1)
  psiAB ~ dunif(0, 1)
  psiBA ~ dunif(0, 1)
  pA ~ dunif(0, 1)
  pB ~ dunif(0, 1)
...
```
]


---
### Our model $(\phi_A, \phi_B, \psi_{AB}, \psi_{BA}, p_A, p_B)$

.small-font[
```{r eval = FALSE}
multisite <- nimbleCode({
...  
  # Define probabilities of state z(t+1) given z(t)
  gamma[1,1] <- phiA * (1 - psiAB)
  gamma[1,2] <- phiA * psiAB
  gamma[1,3] <- 1 - phiA
  gamma[2,1] <- phiB * psiBA
  gamma[2,2] <- phiB * (1 - psiBA)
  gamma[2,3] <- 1 - phiB
  gamma[3,1] <- 0
  gamma[3,2] <- 0
  gamma[3,3] <- 1
...  
```
]


---
### Our model $(\phi_A, \phi_B, \psi_{AB}, \psi_{BA}, p_A, p_B)$

.small-font[
```{r eval = FALSE}
multisite <- nimbleCode({
...  
  # Define probabilities of y(t) given z(t)
  omega[1,1] <- 1 - pA     # Pr(alive A t -> non-detected t)
  omega[1,2] <- pA         # Pr(alive A t -> detected A t)
  omega[1,3] <- 0          # Pr(alive A t -> detected B t)
  omega[2,1] <- 1 - pB     # Pr(alive B t -> non-detected t)
  omega[2,2] <- 0          # Pr(alive B t -> detected A t)
  omega[2,3] <- pB         # Pr(alive B t -> detected B t)
  omega[3,1] <- 1          # Pr(dead t -> non-detected t)
  omega[3,2] <- 0          # Pr(dead t -> detected A t)
  omega[3,3] <- 0          # Pr(dead t -> detected B t)
...
```
]


---
### Our model $(\phi_A, \phi_B, \psi_{AB}, \psi_{BA}, p_A, p_B)$

.small-font[
```{r eval = FALSE}
multisite <- nimbleCode({
...
  # Likelihood 
  for (i in 1:N){
    # Define latent state at first capture
    z[i,first[i]] <- y[i,first[i]] - 1
    for (t in (first[i]+1):K){
      # State process: draw S(t) given S(t-1)
      z[i,t] ~ dcat(gamma[z[i,t-1],1:3])
      # Observation process: draw O(t) given S(t)
      y[i,t] ~ dcat(omega[z[i,t],1:3])
    }
  }
})
```
]

---

<br>
<br>

.center[
```{r echo = FALSE, message = FALSE, warning = FALSE}
library(MCMCvis)
load(here::here("slides","dat","geese_2sites.RData"))
MCMCsummary(mcmc.multisite, round = 2)
```
]

---

.center.nogap[
```{r, echo = FALSE, fig.width = 7.5, fig.asp = 0.818, dev = "svg", message = FALSE, warning = FALSE}
library(MCMCvis)
load(here::here("slides","dat","geese_2sites.RData"))
MCMCplot(mcmc.multisite)
```
]



---
## Disease ecology 

+ disease states; house finches Faustino et al. 2004 et Conn & Cooch 2009


---
# Animal epidemiology

+ 3 states
    + healthy (H)
    + ill (I)
    + Dead (â€ )
+ 4 observations
    + Not seen (0)
    + Captured healthy (1)
    + Captured ill (2)
    + Health status unknown, i.e. seen at distance (3)


---
class: middle
### The model construction: How we should think. 

.center.nogap[
```{r, echo = FALSE, fig.width = 7.5, fig.asp = 0.718, dev = "svg", message = FALSE, warning = FALSE}
ggplot() + 
  geom_point(aes(1, 1), size = 2.5, alpha = .7) + 
  geom_point(aes(1, 1.5), size = 2.5, alpha = .7) + 
  geom_point(aes(1, 2), size = 2.5, alpha = .7) + 
  geom_text(aes(1.5, 2, label = 'not seen (0)'), nudge_x = 1.2, size = 7) + 
  geom_text(aes(1.5, 1.5, label = 'captured healthy (1)'), nudge_x = 1.5, size = 7) + 
  geom_text(aes(1.5, 1, label = 'captured ill (2)'), nudge_x = 1.3, size = 7) +
  geom_text(aes(1.5, 0.5, label = 'status unknown (3)'), nudge_x = 1.5, size = 7) +
  geom_point(aes(2, 0.5), size = 2.5, alpha = .7) + 
  geom_point(aes(2, 1), size = 2.5, alpha = .7) + 
  geom_point(aes(2, 1.5), size = 2.5, alpha = .7) + 
  geom_point(aes(2, 2), size = 2.5, alpha = .7) + 
  geom_text(aes(.5, 2, label = 'healthy'), nudge_x = 0, size = 7) + 
  geom_text(aes(.5, 1.5, label = 'ill'), nudge_x = 0.2, size = 7) + 
  geom_text(aes(.5, 1, label = 'dead'), nudge_x = 0.1, size = 7) + 
  xlim(0, 4.5) + 
  ylim(0.5, 3) + 
  annotate('text', x = .5, y = 2.6, label = 'States', size = 10) + 
  annotate('text', x = 2.7, y = 2.6, label = 'Observations', size = 10) + 
  
  theme_void()
```
]




---
class: middle
### The model construction: How we should think. 

.center.nogap[
```{r, echo = FALSE, fig.width = 7.5, fig.asp = 0.718, dev = "svg", message = FALSE, warning = FALSE}
ggplot() + 
  geom_point(aes(1, 1), size = 2.5, alpha = .7) + 
  geom_point(aes(1, 1.5), size = 2.5, alpha = .7) + 
  geom_point(aes(1, 2), size = 2.5, alpha = .7) + 
  geom_text(aes(1.5, 2, label = 'not seen (0)'), nudge_x = 1.2, size = 7) + 
  geom_text(aes(1.5, 1.5, label = 'captured healthy (1)'), nudge_x = 1.5, size = 7) + 
  geom_text(aes(1.5, 1, label = 'captured ill (2)'), nudge_x = 1.3, size = 7) +
  geom_text(aes(1.5, 0.5, label = 'status unknown (3)'), nudge_x = 1.5, size = 7) +
  geom_point(aes(2, 0.5), size = 2.5, alpha = .7) + 
  geom_point(aes(2, 1), size = 2.5, alpha = .7) + 
  geom_point(aes(2, 1.5), size = 2.5, alpha = .7) + 
  geom_point(aes(2, 2), size = 2.5, alpha = .7) + 
  geom_text(aes(.5, 2, label = 'healthy'), nudge_x = 0, size = 7) + 
  geom_text(aes(.5, 1.5, label = 'ill'), nudge_x = 0.2, size = 7) + 
  geom_text(aes(.5, 1, label = 'dead'), nudge_x = 0.1, size = 7) + 
  xlim(0, 4.5) + 
  ylim(0.5, 3) + 
  annotate('text', x = .5, y = 2.6, label = 'States', size = 10) + 
  annotate('text', x = 2.7, y = 2.6, label = 'Observations', size = 10) + 
  
  geom_segment(aes(x = 1, y = 1, xend = 2, yend = 2), alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  
  theme_void()
```
]



---
class: middle
### The model construction: How we should think. 

.center.nogap[
```{r, echo = FALSE, fig.width = 7.5, fig.asp = 0.718, dev = "svg", message = FALSE, warning = FALSE}
ggplot() + 
  geom_point(aes(1, 1), size = 2.5, alpha = .7) + 
  geom_point(aes(1, 1.5), size = 2.5, alpha = .7) + 
  geom_point(aes(1, 2), size = 2.5, alpha = .7) + 
  geom_text(aes(1.5, 2, label = 'not seen (0)'), nudge_x = 1.2, size = 7) + 
  geom_text(aes(1.5, 1.5, label = 'captured healthy (1)'), nudge_x = 1.5, size = 7) + 
  geom_text(aes(1.5, 1, label = 'captured ill (2)'), nudge_x = 1.3, size = 7) +
  geom_text(aes(1.5, 0.5, label = 'status unknown (3)'), nudge_x = 1.5, size = 7) +
  geom_point(aes(2, 0.5), size = 2.5, alpha = .7) + 
  geom_point(aes(2, 1), size = 2.5, alpha = .7) + 
  geom_point(aes(2, 1.5), size = 2.5, alpha = .7) + 
  geom_point(aes(2, 2), size = 2.5, alpha = .7) + 
  geom_text(aes(.5, 2, label = 'healthy'), nudge_x = 0, size = 7) + 
  geom_text(aes(.5, 1.5, label = 'ill'), nudge_x = 0.2, size = 7) + 
  geom_text(aes(.5, 1, label = 'dead'), nudge_x = 0.1, size = 7) + 
  xlim(0, 4.5) + 
  ylim(0.5, 3) + 
  annotate('text', x = .5, y = 2.6, label = 'States', size = 10) + 
  annotate('text', x = 2.7, y = 2.6, label = 'Observations', size = 10) + 
  

  geom_segment(aes(x = 1, y = 1.5, xend = 2, yend = 1), lty = 2, alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  geom_segment(aes(x = 1, y = 1.5, xend = 2, yend = 2), lty = 2, alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  geom_segment(aes(x = 1, y = 1.5, xend = 2, yend = .5), lty = 2, alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  
  theme_void()
```
]



---
class: middle
### The model construction: How we should think. 

.center.nogap[
```{r, echo = FALSE, fig.width = 7.5, fig.asp = 0.718, dev = "svg", message = FALSE, warning = FALSE}
ggplot() + 
  geom_point(aes(1, 1), size = 2.5, alpha = .7) + 
  geom_point(aes(1, 1.5), size = 2.5, alpha = .7) + 
  geom_point(aes(1, 2), size = 2.5, alpha = .7) + 
  geom_text(aes(1.5, 2, label = 'not seen (0)'), nudge_x = 1.2, size = 7) + 
  geom_text(aes(1.5, 1.5, label = 'captured healthy (1)'), nudge_x = 1.5, size = 7) + 
  geom_text(aes(1.5, 1, label = 'captured ill (2)'), nudge_x = 1.3, size = 7) +
  geom_text(aes(1.5, 0.5, label = 'status unknown (3)'), nudge_x = 1.5, size = 7) +
  geom_point(aes(2, 0.5), size = 2.5, alpha = .7) + 
  geom_point(aes(2, 1), size = 2.5, alpha = .7) + 
  geom_point(aes(2, 1.5), size = 2.5, alpha = .7) + 
  geom_point(aes(2, 2), size = 2.5, alpha = .7) + 
  geom_text(aes(.5, 2, label = 'healthy'), nudge_x = 0, size = 7) + 
  geom_text(aes(.5, 1.5, label = 'ill'), nudge_x = 0.2, size = 7) + 
  geom_text(aes(.5, 1, label = 'dead'), nudge_x = 0.1, size = 7) + 
  xlim(0, 4.5) + 
  ylim(0.5, 3) + 
  annotate('text', x = .5, y = 2.6, label = 'States', size = 10) + 
  annotate('text', x = 2.7, y = 2.6, label = 'Observations', size = 10) + 
  

  geom_segment(aes(x = 1, y = 2, xend = 2, yend = .5), lty = 2, alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  geom_segment(aes(x = 1, y = 2, xend = 2, yend = 1.5), lty = 2, alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  geom_segment(aes(x = 1, y = 2, xend = 2, yend = 2), lty = 2, alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 

  theme_void()
```
]




---
class: middle
### The model construction: How we should think. 

.center.nogap[
```{r, echo = FALSE, fig.width = 7.5, fig.asp = 0.718, dev = "svg", message = FALSE, warning = FALSE}
ggplot() + 
  geom_point(aes(1, 1), size = 2.5, alpha = .7) + 
  geom_point(aes(1, 1.5), size = 2.5, alpha = .7) + 
  geom_point(aes(1, 2), size = 2.5, alpha = .7) + 
  geom_text(aes(1.5, 2, label = 'not seen (0)'), nudge_x = 1.2, size = 7) + 
  geom_text(aes(1.5, 1.5, label = 'captured healthy (1)'), nudge_x = 1.5, size = 7) + 
  geom_text(aes(1.5, 1, label = 'captured ill (2)'), nudge_x = 1.3, size = 7) +
  geom_text(aes(1.5, 0.5, label = 'status unknown (3)'), nudge_x = 1.5, size = 7) +
  geom_point(aes(2, 0.5), size = 2.5, alpha = .7) + 
  geom_point(aes(2, 1), size = 2.5, alpha = .7) + 
  geom_point(aes(2, 1.5), size = 2.5, alpha = .7) + 
  geom_point(aes(2, 2), size = 2.5, alpha = .7) + 
  geom_text(aes(.5, 2, label = 'healthy'), nudge_x = 0, size = 7) + 
  geom_text(aes(.5, 1.5, label = 'ill'), nudge_x = 0.2, size = 7) + 
  geom_text(aes(.5, 1, label = 'dead'), nudge_x = 0.1, size = 7) + 
  xlim(0, 4.5) + 
  ylim(0.5, 3) + 
  annotate('text', x = .5, y = 2.6, label = 'States', size = 10) + 
  annotate('text', x = 2.7, y = 2.6, label = 'Observations', size = 10) + 
  
  geom_segment(aes(x = 1, y = 1, xend = 2, yend = 2), alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  
  geom_segment(aes(x = 1, y = 1.5, xend = 2, yend = 1), lty = 2, alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  geom_segment(aes(x = 1, y = 1.5, xend = 2, yend = 2), lty = 2, alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  geom_segment(aes(x = 1, y = 1.5, xend = 2, yend = .5), lty = 2, alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  
  geom_segment(aes(x = 1, y = 2, xend = 2, yend = .5), lty = 2, alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  geom_segment(aes(x = 1, y = 2, xend = 2, yend = 1.5), lty = 2, alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 
  geom_segment(aes(x = 1, y = 2, xend = 2, yend = 2), lty = 2, alpha = 0.7, arrow = arrow(length = unit(0.02, "npc"))) + 

  theme_void()
```
]


---
### HMM model for disease states w/ uncertainty

Vector of initial state probabilities

$$
\begin{matrix}
& \\
\mathbf{\delta} = 
    \left ( \vphantom{ \begin{matrix} 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    z_t=H & z_t=I & z_t=D \\ \hdashline
\pi_H & 1 - \pi_{H} & 0\\ 
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \end{matrix} } \right )
    \begin{matrix}
    \end{matrix}
\end{matrix}
$$

+ $\pi_H$ is the probability that a newly encountered individual is healthy

+ $\pi_{I} = 1 - \pi_H$ is the probability that a newly encountered individual is ill

---
### HMM model for disease ecology w/ uncertainty

Transition matrix:

$$
\begin{matrix}
& \\
\mathbf{\Gamma} = 
    \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    z_t=H & z_t=I & z_t=D \\ \hdashline
\phi_H (1-\psi_{HI}) & \phi_H \psi_{HI} & 1 - \phi_H\\ 
\phi_{I} \psi_{IH} & \phi_{I} (1-\psi_{IH}) & 1 - \phi_{I}\\ 
0 & 0 & 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right )
    \begin{matrix}
    z_{t-1}=H \\ z_{t-1}=I \\ z_{t-1}=D
    \end{matrix}
\end{matrix}
$$

+ $\phi_H$

+ $\phi_{I}$


---
### HMM model for disease ecology w/ uncertainty

Observation matrix:

$$
\begin{matrix}
& \\
\mathbf{\Omega} = 
    \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12\end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    y_t=0 & y_t=1 & y_t=2 & y_t=3\\ \hdashline
p_H \beta_H & 0 & p_H (1-\beta_H) & 1-p_H\\ 
0 & p_{I} \beta_{I} & p_{I} (1-\beta_{I}) & 1-p_{I}\\ 
0 & 0 & 0 & 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12\end{matrix} } \right )
    \begin{matrix}
    z_{t}=H \\ z_{t}=I \\ z_{t}=D
    \end{matrix}
\end{matrix}
$$

+ $\beta_H$ is the probability to assign a healthy individual to state H

+ $\beta_{I}$ is the probability to assign a sick individual to state I



---
## Individual heterogeneity w/ finite mixtures. 

+ Gray wolves case study with or without transition. 


---
# Individual heterogeneity

+ 3 states
    + alive in class 1 (A1)
    + alive in class 2 (A1)
    + dead (â€ )
+ 4 observations
    + Not captured (0)
    + Captured (1)


---
### HMM model for individual heterogeneity

Vector of initial state probabilities

$$
\begin{matrix}
& \\
\mathbf{\delta} = 
    \left ( \vphantom{ \begin{matrix} 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    z_t=A1 & z_t=A2 & z_t=D \\ \hdashline
\pi & 1 - \pi & 0\\ 
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \end{matrix} } \right )
    \begin{matrix}
    \end{matrix}
\end{matrix}
$$

+ $\pi$ is the probability of being alive in class 1

+ $1 - \pi$ is the probability of being in class 2


---
### HMM model for individual heterogeneity

Transition matrix

$$
\begin{matrix}
& \\
\mathbf{\Gamma} = 
    \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    z_t=A1 & z_t=A2 & z_t=D \\ \hdashline
\phi  & 0 & 1 - \phi\\ 
0 & \phi & 1 - \phi\\ 
0 & 0 & 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right )
    \begin{matrix}
    z_{t-1}=A1 \\ z_{t-1}=A2 \\ z_{t-1}=D
    \end{matrix}
\end{matrix}
$$



---
### HMM model for individual heterogeneity

Transition matrix, with change in heterogeneity class:

$$
\begin{matrix}
& \\
\mathbf{\Gamma} = 
    \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    z_t=A1 & z_t=A2 & z_t=D \\ \hdashline
\phi (1-\psi_{12}) & \phi \psi_{12} & 1 - \phi\\ 
\phi \psi_{21} & \phi (1-\psi_{21}) & 1 - \phi\\ 
0 & 0 & 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right )
    \begin{matrix}
    z_{t-1}=A1 \\ z_{t-1}=A2 \\ z_{t-1}=D
    \end{matrix}
\end{matrix}
$$


---
### HMM model for individual heterogeneity

Observation matrix:

$$
\begin{matrix}
& \\
\mathbf{\Omega} = 
    \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12\end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    y_t=0 & y_t=1\\ \hdashline
1 - p_1 & p_1\\ 
1 - p_2 & p_2\\ 
1 & 0
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12\end{matrix} } \right )
    \begin{matrix}
    z_{t}=A1 \\ z_{t}=A2 \\ z_{t}=D
    \end{matrix}
\end{matrix}
$$



---
## Other examples

+ Add matrices like in multistate slides for examples we will not cover

+ Trap-dependence

+ Memory model

+ Sex

---
## Further reading

+ Seminal paper by Pradel (2005); see also Gimenez et al. (2012) for a review
+ Dupuis (1995) had a similar idea, for the Arnason-Schwarz model

+ Turek, D., Wehrhahn, C. & Gimenez, O. Bayesian non-parametric detection heterogeneity in ecological models. Environ Ecol Stat (2021). https://doi.org/10.1007/s10651-021-00489-1

+ Conn, P.B. and Cooch, E.G. (2009), Multistate captureâ€“recapture analysis under imperfect state observation: an application to disease models. Journal of Applied Ecology, 46: 486-492. https://doi.org/10.1111/j.1365-2664.2008.01597.x

+ Sarah Cons Biol paper as well.
